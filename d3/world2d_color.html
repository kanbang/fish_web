<html>

<head>
	<meta charset="utf-8">
	<title>range</title>
	<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no"
		name="viewport" />
</head>
<style>
	.province {
		stroke: black;
		stroke-width: 1px;
	}

	svg {
		border: 1px solid black;
	}

	text {
		text-anchor: middle;
		pointer-events: none;
	}

	.tooltip {
		font-family: simsun;
		font-size: 16px;
		min-width: 120;
		height: auto;
		position: absolute;
		text-align: center;
		border-style: solid;
		border-width: 1px;
		background-color: white;
		border-radius: 5px;
		opacity: 0;
		padding: 10px;
	}
</style>

<body>
	<script src='/d3.min.js'></script>
	<script src='/topojson.js'></script>
	<script>
		const trim = (str, chars) => str.split(chars).filter(Boolean).join(chars);

		function getMaxValueKey(obj) {
			return Object.keys(obj).reduce((a, b) => obj[a] > obj[b] ? a : b);
		}

		function getMaxValue(obj) {
			return Math.max.apply(null, Object.values(obj));
		}

		function csvToJson(filePath) {
			let result = []
			var xhr = new XMLHttpRequest();
			xhr.open("GET", filePath, false);
			xhr.onload = function (e) {
				if (xhr.readyState === 4) {
					if (xhr.status === 200) {
						result = csvJSON(xhr.responseText)
					} else {
						console.error(xhr.statusText);
					}
				}
			};
			xhr.send(null);
			return result
		}

		function csvJSON(csv) {
			var data = {}
			var lines = csv.split("\n");

			// var result = [];

			var headers = lines[0].split(",");

			for (var i = 1; i < lines.length; i++) {
				// var obj = {};
				var currentline = lines[i].split(",");

				var country = currentline[12];
				try {
					var profit = parseFloat(trim(currentline[8], '$'));

					if (data[country]) {
						data[country] += profit;
					} else {
						data[country] = profit;
					}
				} catch (error) {}

				// for (var j = 0; j < headers.length; j++) {
				// 	obj[headers[j]] = currentline[j];
				// }

				// result.push(obj);
			}

			return data;
		}

		var width = document.body.clientWidth;
		var height = document.body.clientHeight;
		var padding = 50;
		var innerWidth = width - 2 * padding;
		var innerHeight = height - 2 * padding;

		var svg = d3.select("body").append("svg")
			.attr('width', innerWidth)
			.attr('height', innerHeight)
			.attr('transform', 'translate(' + padding + ',' + padding + ')')

		var tooltip = d3.select("body").append("div")
			.attr("class", "tooltip")
			.attr("opacity", 0.0);

		var projection = d3.geoMercator()
		var path = d3.geoPath().projection(projection);
		var root;

		window.addEventListener('resize', function () {
			width = document.body.clientWidth;
			height = document.body.clientHeight;
			innerWidth = width - 2 * padding;
			innerHeight = height - 2 * padding;

			svg.attr('width', innerWidth)
				.attr('height', innerHeight)
				.attr('transform', 'translate(' + padding + ',' + padding + ')')

			projection.fitSize([innerWidth, innerHeight], root)

			svg.selectAll("path").attr("d", path);
		})


		d3.json("countries-110m.json").then(function (toporoot) {
			root = topojson.feature(toporoot, toporoot.objects.countries);
			projection.fitSize([innerWidth, innerHeight], root)
			console.log(toporoot, root)

			//路径分组元素
			var g = svg.append("g");

			//路径元素
			var provinces = g.selectAll("path")
				.data(root.features)
				.enter()
				.append("path")
				.attr("class", "province")
				.attr("stroke", "#000")
				.attr("stroke-width", 1)
				.attr("fill", "royalblue")
				.attr("d", path)

			svg.selectAll("text")
				.data(root.features)
				.enter()
				.append("text")
				.text(function (d, i) {
					return d.properties.name
				})
				.attr("fill", "black")
				.attr("x", function (d) {
					return path.centroid(d)[0];
				})
				.attr("y", function (d) {
					return path.centroid(d)[1];
				})
				.style("font-size", "10px")

			var values = csvToJson('ecommerce.csv');


			//求最大值和最小值
			var minvalue = 0;
			var maxvalue = getMaxValue(values).toFixed(2);

			//定义一个线性比例尺，将最小值和最大值之间的值映射到[0, 1]
			var linear = d3.scaleLinear()
				.domain([minvalue, maxvalue])
				.range([0, 1]);

			//定义最小值和最大值对应的颜色
			var a = d3.rgb(255, 255, 255); //浅蓝色
			var b = d3.rgb(255, 0, 0); //蓝色

			//颜色插值函数
			var computeColor = d3.interpolate(a, b);

			//定义一个线性渐变
			var defs = svg.append("defs");

			var linearGradient = defs.append("linearGradient")
				.attr("id", "linearColor")
				.attr("x1", "0%")
				.attr("y1", "0%")
				.attr("x2", "100%")
				.attr("y2", "0%");

			var stop1 = linearGradient.append("stop")
				.attr("offset", "0%")
				.style("stop-color", a.toString());

			var stop2 = linearGradient.append("stop")
				.attr("offset", "100%")
				.style("stop-color", b.toString());

			//添加一个矩形，并应用线性渐变
			var colorRect = svg.append("rect")
				.attr("x", 20)
				.attr("y", 490)
				.attr("width", 140)
				.attr("height", 30)
				.style("fill", "url(#" + linearGradient.attr("id") + ")");

			//添加文字
			var minValueText = svg.append("text")
				.attr("class", "valueText")
				.attr("x", 20)
				.attr("y", 490)
				.attr("dy", "-0.3em")
				.text(function () {
					return minvalue;
				});

			var maxValueText = svg.append("text")
				.attr("class", "valueText")
				.attr("x", 160)
				.attr("y", 490)
				.attr("dy", "-0.3em")
				.text(function () {
					return maxvalue;
				});

			provinces.attr("fill", function (d, i) {
					var t = linear(values[d.properties.name] || 0);
					var color = computeColor(t);
					return color.toString();
				})
				.on("mousemove", function (d, i) {
					d3.select(this)
						.attr("fill", "dodgerblue");

					var x = d3.event.pageX;
					var y = d3.event.pageY + 30;

					var profit = values[d.properties.name];

					tooltip.html(d.properties.name + ": $" + (profit ? profit.toFixed(2) : "0"))
						.style("left", x + "px")
						.style("top", y + "px")
						.style("opacity", 1.0);
				})
				.on("mouseout", function (d, i) {
					var t = linear(values[d.properties.name] || 0);
					var color = computeColor(t).toString();
					d3.select(this)
						.attr("fill", color);
					tooltip.style("opacity", 0.0);
				});
		}).catch(function () {
			console.log('err1');
		});
	</script>

</body>

</html>