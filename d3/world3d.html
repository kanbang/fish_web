<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<title>Earth Countrys</title>
	<script src='/d3.min.js'></script>
	<script src='/topojson.js'></script>

</head>
<style type="text/css">
	.water {
		fill: #00248F;
		cursor: move;
	}

	.land {
		fill: #A98B6F;
		stroke: #FFF;
		stroke-width: 0.7px;
		cursor: move;
	}

	.land:hover {
		fill: #33CC33;
		stroke-width: 1px;
	}

	.focused {
		fill: #33CC33;
	}

	select {
		position: absolute;
		top: 20px;
		left: 580px;
		border: solid #ccc 1px;
		padding: 3px;
		box-shadow: inset 1px 1px 2px #ddd8dc;
	}

	.countryTooltip {
		position: absolute;
		display: none;
		pointer-events: none;
		background: #fff;
		padding: 5px;
		text-align: left;
		border: solid #ccc 1px;
		color: #666;
		font-size: 14px;
		font-family: sans-serif;
	}
</style>

<body>
	<script>
		var width = 1200,
			height = 900,
			sens = 0.25,
			focused;

		var projection = d3.geoOrthographic()
			.scale(360)
			.rotate([0, 0])
			.translate([width / 2, height / 2])
			.clipAngle(90);

		var path = d3.geoPath()
			.projection(projection);


		var svg = d3.select("body").append("svg")
			.attr("width", width)
			.attr("height", height);


		svg.append("path")
			.datum({
				type: "Sphere"
			})
			.attr("class", "water")
			.attr("d", path)
			.call(d3.drag()
				.subject(function () {
					var r = projection.rotate();
					return {
						x: r[0] / sens,
						y: -r[1] / sens
					};
				})
				.on("drag", function () {
					var rotate = projection.rotate();
					projection.rotate([d3.event.x * sens, -d3.event.y * sens, rotate[2]]);
					svg.selectAll("path.land").attr("d", path);
					svg.selectAll(".focused").classed("focused", focused = false);
				}));

		var countryTooltip = d3.select("body").append("div").attr("class", "countryTooltip");

		const trim = (str, chars) => str.split(chars).filter(Boolean).join(chars);


		function csvJSON(csv) {
			var data = {}
			for (line of csv) {

				var country = line.Country;
				try {
					var profit = parseFloat(trim(line.Profit, '$'));

					if (data[country]) {
						data[country] += profit;
					} else {
						data[country] = profit;
					}
				} catch (error) {}
			}

			return data;
		}

		Promise.all([
			d3.json("countries-110m.json"),
			d3.csv("ecommerce.csv"),
		]).then(function (files) {
			var profits = csvJSON(files[1]);

			var world = files[0];
			var countries = topojson.feature(world, world.objects.countries).features;

			var world = svg.selectAll("path.land")
				.data(countries)
				.enter().append("path")
				.attr("class", "land")
				.attr("d", path)
				.call(d3.drag()
					.subject(function () {
						var r = projection.rotate();
						return {
							x: r[0] / sens,
							y: -r[1] / sens
						};
					})
					.on("drag", function () {
						var rotate = projection.rotate();
						projection.rotate([d3.event.x * sens, -d3.event.y * sens, rotate[2]]);
						svg.selectAll("path.land").attr("d", path);
						svg.selectAll(".focused").classed("focused", focused = false);
					}))

				.on("mouseover", function (d) {

					var profit = profits[d.properties.name];

					var tip = d.properties.name + ": $" + (profit ? profit.toFixed(2) : "0");

					countryTooltip.text(tip)
						.style("left", (d3.event.pageX + 7) + "px")
						.style("top", (d3.event.pageY - 15) + "px")
						.style("display", "block")
						.style("opacity", 1);
				})
				.on("mouseout", function (d) {
					countryTooltip.style("opacity", 0)
						.style("display", "none");
				})
				.on("mousemove", function (d) {
					countryTooltip.style("left", (d3.event.pageX + 7) + "px")
						.style("top", (d3.event.pageY - 15) + "px");
				});


			d3.select("select").on("change", function () {
				var rotate = projection.rotate(),
					focusedCountry = country(countries, this),
					p = d3.geo.centroid(focusedCountry);

				svg.selectAll(".focused").classed("focused", focused = false);

				(function transition() {
					d3.transition()
						.duration(2500)
						.tween("rotate", function () {
							var r = d3.interpolate(projection.rotate(), [-p[0], -p[1]]);
							return function (t) {
								projection.rotate(r(t));
								svg.selectAll("path").attr("d", path)
									.classed("focused", function (d, i) {
										return d.id == focusedCountry.id ? focused = d :
											false;
									});
							};
						})
				})();
			});

		

		}).catch(function (err) {
		})
	</script>
</body>

</html>